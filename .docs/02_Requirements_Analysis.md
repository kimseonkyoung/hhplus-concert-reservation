# 요구사항 분석

## 1-1. 유저 토큰 발급 API
### 상세 설명
- 유저에게 UUID 형식의 토큰을 발급하여 대기열 관리에 사용.
- 유저는 대기열에 진입할 때 UUID를 발급받으며, 해당 UUID는 이후 대기열 상태 관리의 키로 사용됨.
- 폴링 방식으로 대기열 상태를 확인하며, UUID 유무로 토큰 생성과 재발급을 관리함.
- UUID 상태는 빠른 조회, 삭제가 가능하도록 인덱스 설정 필요. -> 해당 UUID를 QUEUE 테이블에서 조회시 빠른 성능 보장

### 기술적 고려사항
- UUID 생성은 고유성과 충돌 방지를 보장해야 함. -> 한 ID로 다수의 UUID 생성 요청 고려

### 비즈니스적 고려사항
- 중복 요청 및 무한 대기 방지를 위해 TTL(Time To Live)을 설정하여 토큰 유효 기간 관리.

## 1-2. 유저 대기열 관리 API
### 상세 설명
- 유저의 UUID를 대기열 관리에 사용.
- 유저는 지속적인 요청으로 서버에 UUID 토큰의 상태를 질의하는 상태.

### 기술적 고려사항
- 해당 UUID의 상태를 지속적으로 관리하며, 질의가 요청됐을 때 해당 UUID의 순번과 상태를 유저에게 반환
- 상태가 ACTIVE -> 대기열에서 예약 페이지로 접근 가능
- 상태가 WATI -> POSITION을 확인해 해당 대기 순번 반환
- UUID 상태는 빠른 조회, 삭제가 가능하도록 인덱스 설정 필요. -> 해당 UUID를 QUEUE 테이블에서 조회시 빠른 성능 보장

### 비즈니스적 고려사항
- 중복 요청 및 무한 대기 방지를 위해 TTL(Time To Live)을 설정하여 토큰 유효 기간 관리.
- 무한 대기 방지 이로인한 병목현상을 방지하기 위해 스케줄러를 통해 일정 시간 간격으로 일정 인원을 예약 페이지로 접근시킴

---

## 2. 예약 가능 날짜 / 좌석 API
### 상세 설명
- 유저는 예약 가능한 날짜 목록을 YYYY-MM-DD 형식으로 조회 가능.
- 조회 가능한 날짜는 현재 날짜 이후 1개월로 제한.
- 예약 가능한 좌석 번호(1~50)와 이미 예약된 좌석을 제외한 정보 제공.

### 기술적 고려사항
- 날짜와 좌석 정보를 효율적으로 관리하기 위해 데이터베이스 설계 최적화 필요.
- 예약된 좌석 정보는 실시간 반영이 가능해야 함.

### 비즈니스적 고려사항
- 날짜 범위 및 좌석 정보의 동적 확장을 위해 유지보수성 고려.

---

## 3. 좌석 예약 요청 API
### 상세 설명
- 유저는 특정 날짜와 좌석 번호를 지정하여 예약 요청.
- 좌석이 다른 사용자에 의해 예약 대기 상태일 경우 예외 반환.
- 요청 성공 시 좌석은 5분간 임시 배정되며, 결제가 완료되지 않으면 해제.

### 기술적 고려사항
- 임시 배정을 관리하기 위한 만료 정책(TTL)과 상태코드(STATUS) 도입.
- 동시 요청 처리 시 데이터 무결성을 보장하기 위한 락(lock) 메커니즘 필요.
- 5분 타이머 로직은 스케줄러로 구현.

### 비즈니스적 고려사항
- 결제 시스템과 연계하여 상태 전환(대기 → 예약완료)을 실시간 반영.

---

## 4. 잔액 충전 / 조회 API
### 상세 설명
- 유저는 자신의 잔액을 조회하고, 최소/최대 금액 범위 내에서 충전 가능.
- 충전된 잔액은 결제 시 사용되며, 결제 시 잔액 차감.

### 기술적 고려사항
- 안전한 잔액 관리를 위해 트랜잭션 기반의 데이터 처리 필요.

### 비즈니스적 고려사항
- 충전 실패나 충전 후 금액 미반영 문제를 방지하기 위한 안정적인 결제 시스템 연계.

---

## 5. 결제 API
### 상세 설명
- 결제는 유저의 잔액에서 차감하여 완료.
- 잔액 부족 시 결제 실패 예외 반환.
- 결제 완료 시 대기열 토큰 만료 및 좌석 상태 갱신.

### 기술적 고려사항
- 잔액 차감 및 좌석 상태 갱신은 동일 트랜잭션 내에서 처리.
- 결제 과정에서 외부 결제 시스템 연계 시 타임아웃 처리 필요.

### 비즈니스적 고려사항
- 결제 실패 시 사용자 경험 개선을 위해 상세 실패 사유 반환.
- 결제 완료 후 이벤트 발생(이메일 발송 등)을 통한 유저 알림 제공.

---

# 분석 결과 및 주요 의사결정 내용
1. 모든 상태 변경은 트랜잭션으로 관리하여 데이터 무결성 보장.
2. 동시성 문제 해결을 위해 적절한 락 메커니즘과 데이터베이스 인덱스를 설계.




---

### 1. 대기열 구간 존재 X 
#### -> 유저 예매 페이지 진입시 토큰 검증 후 유효한 토큰일시 대기열 진입.
<div style="width: 200px; height: 50px; border: 2px solid black; text-align: center; line-height: 50px; margin-bottom: 10px;">
  유저 예매 페이지 진입
</div>
↓
<div style="width: 200px; height: 50px; border: 2px solid black; text-align: center; line-height: 50px; margin-bottom: 10px;">
  예약 날짜 조회
</div>


### 2. 대기열 구간 존재 O 
#### -> 유저 예매 페이지 진입시 모든 토큰은 생성과 재발급. 대기열에서 폴링 요청시 토큰이 유효한지만 검증(이미 하나만 존재한다고 가정)
<div style="width: 200px; height: 50px; border: 2px solid black; text-align: center; line-height: 50px; margin-bottom: 10px;">
  유저 예매 페이지 진입
</div>
↓
<div style="width: 200px; height: 50px; border: 2px solid black; text-align: center; line-height: 50px; margin-bottom: 10px;">
  대기열 구간
</div>
↓
<div style="width: 200px; height: 50px; border: 2px solid black; text-align: center; line-height: 50px; margin-bottom: 10px;">
  예약 날짜 조회
</div>







